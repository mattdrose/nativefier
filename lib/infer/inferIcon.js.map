{"version":3,"sources":["infer/inferIcon.js"],"names":["downloadFile","allowedIconFormats","setGracefulCleanup","GITCLOUD_SPACE_DELIMITER","getMaxMatchScore","iconWithScores","reduce","maxScore","currentIcon","currentScore","score","getMatchingIcons","iconsWithScores","filter","item","map","Object","assign","ext","extname","url","mapIconWithMatchScore","fileIndex","targetUrl","normalisedTargetUrl","toLowerCase","itemWords","name","split","word","includes","inferIconFromStore","platform","allowedFormats","Set","then","iconsMatchingScore","iconsMatchingExt","has","icon","matchingIcon","iconUrl","writeFilePromise","outPath","data","Promise","resolve","reject","writeFile","error","inferFromPage","outDir","preferredExt","outfilePath","join","inferIconFromUrlToPath","inferIcon","tmpObj","dirSync","unsafeCleanup","tmpPath"],"mappings":"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","file":"inferIcon.js","sourcesContent":["import pageIcon from 'page-icon';\nimport path from 'path';\nimport fs from 'fs';\nimport tmp from 'tmp';\nimport gitCloud from 'gitcloud';\nimport helpers from './../helpers/helpers';\n\nconst { downloadFile, allowedIconFormats } = helpers;\ntmp.setGracefulCleanup();\n\nconst GITCLOUD_SPACE_DELIMITER = '-';\n\nfunction getMaxMatchScore(iconWithScores) {\n  return iconWithScores.reduce((maxScore, currentIcon) => {\n    const currentScore = currentIcon.score;\n    if (currentScore > maxScore) {\n      return currentScore;\n    }\n    return maxScore;\n  }, 0);\n}\n\n/**\n * also maps ext to icon object\n */\nfunction getMatchingIcons(iconsWithScores, maxScore) {\n  return iconsWithScores\n    .filter(item => item.score === maxScore)\n    .map(item => Object.assign({}, item, { ext: path.extname(item.url) }));\n}\n\nfunction mapIconWithMatchScore(fileIndex, targetUrl) {\n  const normalisedTargetUrl = targetUrl.toLowerCase();\n  return fileIndex\n    .map((item) => {\n      const itemWords = item.name.split(GITCLOUD_SPACE_DELIMITER);\n      const score = itemWords.reduce((currentScore, word) => {\n        if (normalisedTargetUrl.includes(word)) {\n          return currentScore + 1;\n        }\n        return currentScore;\n      }, 0);\n\n      return Object.assign({}, item, { score });\n    });\n}\n\nfunction inferIconFromStore(targetUrl, platform) {\n  const allowedFormats = new Set(allowedIconFormats(platform));\n\n  return gitCloud('https://jiahaog.github.io/nativefier-icons/')\n    .then((fileIndex) => {\n      const iconWithScores = mapIconWithMatchScore(fileIndex, targetUrl);\n      const maxScore = getMaxMatchScore(iconWithScores);\n\n      if (maxScore === 0) {\n        return null;\n      }\n\n      const iconsMatchingScore = getMatchingIcons(iconWithScores, maxScore);\n      const iconsMatchingExt = iconsMatchingScore.filter(icon => allowedFormats.has(icon.ext));\n      const matchingIcon = iconsMatchingExt[0];\n      const iconUrl = matchingIcon && matchingIcon.url;\n\n      if (!iconUrl) {\n        return null;\n      }\n      return downloadFile(iconUrl);\n    });\n}\n\nfunction writeFilePromise(outPath, data) {\n  return new Promise((resolve, reject) => {\n    fs.writeFile(outPath, data, (error) => {\n      if (error) {\n        reject(error);\n        return;\n      }\n      resolve(outPath);\n    });\n  });\n}\n\nfunction inferFromPage(targetUrl, platform, outDir) {\n  let preferredExt = '.png';\n  if (platform === 'win32') {\n    preferredExt = '.ico';\n  }\n\n  // todo might want to pass list of preferences instead\n  return pageIcon(targetUrl, { ext: preferredExt })\n    .then((icon) => {\n      if (!icon) {\n        return null;\n      }\n\n      const outfilePath = path.join(outDir, `/icon${icon.ext}`);\n      return writeFilePromise(outfilePath, icon.data);\n    });\n}\n\n/**\n *\n * @param {string} targetUrl\n * @param {string} platform\n * @param {string} outDir\n */\nfunction inferIconFromUrlToPath(targetUrl, platform, outDir) {\n  return inferIconFromStore(targetUrl, platform)\n    .then((icon) => {\n      if (!icon) {\n        return inferFromPage(targetUrl, platform, outDir);\n      }\n\n      const outfilePath = path.join(outDir, `/icon${icon.ext}`);\n      return writeFilePromise(outfilePath, icon.data);\n    });\n}\n\n/**\n * @param {string} targetUrl\n * @param {string} platform\n */\nfunction inferIcon(targetUrl, platform) {\n  const tmpObj = tmp.dirSync({ unsafeCleanup: true });\n  const tmpPath = tmpObj.name;\n  return inferIconFromUrlToPath(targetUrl, platform, tmpPath);\n}\n\nexport default inferIcon;\n"]}